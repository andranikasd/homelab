# Portainer GitOps Configuration

This directory contains the GitOps configuration and stack definitions for Portainer.

## Files

- `gitops-config.json` - Main GitOps configuration (generated by Terraform)
- `traefik-stack.yml` - Traefik reverse proxy stack
- `crowdsec-stack.yml` - CrowdSec WAF stack
- `oauth2-proxy-stack.yml` - OAuth2 authentication proxy stack
- `monitoring-stack.yml` - Monitoring exporters stack

## Setup in Portainer

1. **Access Portainer**: Navigate to `https://your-domain:9443`
2. **Configure Git Repository**:
   - Go to Settings > GitOps
   - Add your Git repository URL
   - Configure authentication (username/token)
   - Set the path to `stacks/`
3. **Enable Auto-Deploy**:
   - Enable automatic deployment
   - Configure webhook if needed
4. **Deploy Stacks**:
   - Stacks will be automatically deployed from Git
   - Monitor deployment status in Portainer

## Stack Dependencies

The stacks should be deployed in this order:
1. **Traefik** - Reverse proxy and load balancer
2. **CrowdSec** - WAF and security
3. **OAuth2 Proxy** - Authentication
4. **Monitoring** - Metrics exporters

## Environment Variables

Make sure to set the following environment variables in Portainer:
- `DOMAIN` - Your primary domain
- `EMAIL` - Email for Let's Encrypt certificates
- `TRAEFIK_AUTH` - Basic auth for Traefik dashboard
- `CROWDSEC_AUTH` - Basic auth for CrowdSec dashboard
- `OAUTH2_PROVIDER` - OAuth2 provider (google, github, etc.)
- `OAUTH2_REDIRECT_URL` - OAuth2 redirect URL
- `OAUTH2_COOKIE_SECRET` - Random string for cookie encryption

## Monitoring Endpoints

The monitoring stack exposes the following endpoints:
- `node-exporter.your-domain` - System metrics
- `docker-exporter.your-domain` - Docker metrics
- `traefik-exporter.your-domain` - Traefik metrics
- `crowdsec-exporter.your-domain` - CrowdSec metrics

These can be scraped by your external Prometheus instance in Kubernetes.
